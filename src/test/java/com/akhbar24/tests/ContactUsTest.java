package com.akhbar24.tests;
import io.appium.java_client.AppiumBy;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.testng.Assert;
import org.testng.annotations.Test;

import java.time.Duration;
import java.util.List;


import com.akhbar24.utils.BaseTest;

public class ContactUsTest extends BaseTest {

    private WebElement waitForElement(By locator) {
        return new WebDriverWait(driver, Duration.ofSeconds(60))
                .until(ExpectedConditions.presenceOfElementLocated(locator));
    }

     private void scrollToText(String visibleText) {
        driver.findElement(AppiumBy.androidUIAutomator(
                "new UiScrollable(new UiSelector().scrollable(true)).scrollIntoView("
                        + "new UiSelector().descriptionContains(\"" + visibleText + "\"))"));
    }

    private void verifyUserIsLoggedIn() {
        boolean isHomeVisible = driver.getPageSource().contains("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©");
        Assert.assertTrue(isHomeVisible, "âŒ Ù„Ù… ÙŠØªÙ… Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");

        waitForElement(AppiumBy.accessibilityId("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")).click();
        String userStatus = waitForElement(By.xpath("//android.view.View[@content-desc]"))
                .getAttribute("content-desc");
        System.out.println("ğŸ‘¤ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + userStatus);
        Assert.assertFalse(userStatus.contains("Ø²Ø§Ø¦Ø±"), "âŒ Ù…Ø§ Ø²Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø§Ø¦Ø±Ù‹Ø§ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù… ÙŠÙ†Ø¬Ø­.");
    }

    @Test
    public void testContactUsFormSubmission() {

        try {
            System.out.println("ğŸš€ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            waitForElement(AppiumBy.accessibilityId("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")).click();
            waitForElement(By.xpath("//android.view.View[@content-desc='ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„']")).click();

            List<WebElement> inputs = driver.findElements(By.className("android.widget.EditText"));
            Actions actions = new Actions(driver);
            actions.click(inputs.get(0)).perform();
            inputs.get(0).sendKeys("asilyacoub1@gmail.com");

            actions.click(inputs.get(1)).perform();
            inputs.get(1).sendKeys("123456789");

            waitForElement(AppiumBy.accessibilityId("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")).click();
            Thread.sleep(4000);
            verifyUserIsLoggedIn();

            // Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            waitForElement(AppiumBy.accessibilityId("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")).click();

            // Scroll Ø¥Ù„Ù‰ "Ø§ØªØµÙ„ Ø¨Ù†Ø§"
            scrollToText("Ø§ØªØµÙ„ Ø¨Ù†Ø§");

            // Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§ØªØµÙ„ Ø¨Ù†Ø§"
            waitForElement(AppiumBy.accessibilityId("Ø§ØªØµÙ„ Ø¨Ù†Ø§")).click();

            // âŒ¨ï¸ Ø§Ù„Ø§Ø³Ù…
            WebElement nameField = waitForElement(By.xpath("//android.widget.EditText[1]"));
            nameField.click();
            nameField.sendKeys("Asil");

            // âŒ¨ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            WebElement emailField = waitForElement(By.xpath("//android.widget.EditText[2]"));
            emailField.click();
            emailField.sendKeys("asilyacoub1@gmail.com");

            // âŒ¨ï¸ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            WebElement messageField = waitForElement(By.xpath("//android.widget.EditText[3]"));
            messageField.click();
            messageField.sendKeys("This is a test message generated by an automation script");
            // Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø±Ø³Ø§Ù„"
            waitForElement(AppiumBy.accessibilityId("Ø¥Ø±Ø³Ø§Ù„")).click();

            // Ø§Ù†ØªØ¸Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ (Ø¨ÙØ±Ø¶ ØªØ¸Ù‡Ø± Ø¹Ù†ØµØ± content-desc ÙÙŠÙ‡ "ØªÙ…")
            By successMsgLocator = By.xpath("//android.view.View[contains(@content-desc, 'ØªÙ…')]");
            WebElement successMsg = new WebDriverWait(driver, Duration.ofSeconds(5))
                    .until(driver -> driver.findElements(successMsgLocator).size() > 0
                            ? driver.findElement(successMsgLocator)
                            : null);

            Assert.assertNotNull(successMsg, "âŒ Ù„Ù… ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
            System.out.println("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");

        } catch (Exception e) {
            takeScreenshot("contact_us_failure");
            Assert.fail("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.getMessage());
        }
    }
}
